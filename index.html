<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMODAK | The Feed</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.11.1/ethers.umd.min.js"></script>
    <style>
        /* --- ESTILOS RETRO --- */
        body { background-color: #1a0b2e; background-image: url('https://upload.wikimedia.org/wikipedia/commons/5/59/Monad_Logo_Purple.png'); background-size: 60px; font-family: 'Verdana', sans-serif; font-size: 11px; margin: 0; color: #000; }
        
        #container { width: 850px; margin: 15px auto; background-color: #fff; min-height: 100vh; border: 3px solid #200052; display: flex; flex-direction: column; }
        
        .nav { background-color: #200052; height: 40px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; color: white; font-weight: bold; font-size: 14px; }
        
        .grid { display: flex; flex: 1; }
        
        /* Lateral Esquerda (Perfil) */
        .col-left { width: 280px; background: #E5E5E5; padding: 15px; text-align: center; border-right: 2px solid #000; }
        .pic-box { border: 2px solid #000; padding: 5px; background: white; margin-bottom: 10px; }
        .pic-box img { width: 100%; height: auto; aspect-ratio: 1/1; object-fit: cover; }
        
        /* Lateral Direita (Feed) */
        .col-right { flex: 1; padding: 20px; background: #fff; }

        /* Componentes do Feed */
        .post-box { border: 2px solid #200052; background: #f0f0f0; padding: 10px; margin-bottom: 20px; }
        .post-box textarea { width: 96%; height: 60px; border: 1px solid #999; padding: 5px; font-family: sans-serif; resize: none; }
        .post-actions { margin-top: 5px; display: flex; justify-content: space-between; align-items: center; }
        
        .feed-item { border: 1px solid #ccc; padding: 10px; margin-bottom: 15px; background: #fff; box-shadow: 2px 2px 0px #ccc; }
        .feed-header { display: flex; align-items: center; margin-bottom: 8px; border-bottom: 1px dashed #ccc; padding-bottom: 5px; }
        .feed-avatar { width: 40px; height: 40px; border: 1px solid #000; margin-right: 10px; object-fit: cover; }
        .feed-info { font-size: 10px; color: #555; }
        .feed-name { font-weight: bold; font-size: 12px; color: #200052; display: block; }
        .feed-content { font-size: 12px; line-height: 1.4; margin-bottom: 10px; white-space: pre-wrap; }
        .feed-img { max-width: 100%; border: 1px solid #000; margin-top: 5px; display: block; }

        /* BotÃµes */
        button { cursor: pointer; border: 1px solid #000; background: #fff; font-weight: bold; padding: 5px 10px; }
        button:hover { background: #200052; color: white; }
        .btn-post { background: #200052; color: white; }

        /* Modal Editor */
        #editor { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #f0f0f0; border: 3px solid #200052; padding: 20px; width: 400px; z-index: 999; box-shadow: 0 0 0 100vmax rgba(0,0,0,0.7); }
        input[type="text"], textarea { width: 95%; padding: 5px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="container">
    <div class="nav">
        <div>ðŸ’œ EMODAK FEED</div>
        <div id="auth-area"><button onclick="connectWallet()">[ Connect Wallet ]</button></div>
    </div>

    <div class="grid">
        <!-- PERFIL (ESQUERDA) -->
        <div class="col-left">
            <h2 id="display-name" style="margin-top:0;">Guest</h2>
            <div class="pic-box"><img id="display-img" src="https://placehold.co/300?text=?"></div>
            <div style="margin-bottom:15px;">"<span id="display-status">...</span>"</div>
            <button id="edit-btn" style="display:none; width:100%" onclick="openEditor()">Edit Profile</button>
            <hr>
            <div style="text-align:left; font-size:10px;">
                <b>Interests:</b> <span id="display-interests">-</span><br><br>
                <b>Bio:</b> <span id="display-bio">-</span>
            </div>
        </div>

        <!-- FEED (DIREITA) -->
        <div class="col-right">
            
            <!-- Caixa de Postagem -->
            <div class="post-box" id="post-area" style="display:none;">
                <b>Update your status / Post to feed:</b>
                <textarea id="post-text" placeholder="Express your sadness..."></textarea>
                <div class="post-actions">
                    <input type="file" id="post-file" accept="image/*" style="font-size:10px;">
                    <button class="btn-post" onclick="submitPost()">POST UPDATE</button>
                </div>
            </div>

            <div style="border-bottom: 1px solid #000; margin-bottom: 10px; font-weight: bold; color: #200052;">
                Latest Updates from the Network
            </div>

            <!-- Onde os posts vÃ£o aparecer -->
            <div id="feed-container">
                <div style="text-align:center; padding:20px;">Loading feed...</div>
            </div>

        </div>
    </div>
</div>

<!-- EDITOR DE PERFIL -->
<div id="editor">
    <h3>Edit Profile</h3>
    <label>Name:</label><input type="text" id="in-name">
    <label>Status:</label><input type="text" id="in-status">
    <label>Avatar:</label><br><input type="file" id="in-avatar-file"><br><br>
    <label>Interests:</label><input type="text" id="in-interests">
    <label>Bio:</label><textarea id="in-bio"></textarea>
    <input type="hidden" id="in-avatar-current">
    <button onclick="saveProfile()" style="width:100%; background:#200052; color:white;">SAVE</button>
    <button onclick="document.getElementById('editor').style.display='none'" style="width:100%; margin-top:5px;">CANCEL</button>
</div>

<script>
    let currentWallet = null;
    let currentUserData = { name: 'Guest', avatar: 'https://placehold.co/300' };

    // --- INICIALIZAÃ‡ÃƒO ---
    window.onload = () => {
        loadFeed(); // Carrega o feed mesmo sem logar
    };

    // --- CARTEIRA E PERFIL ---
    async function connectWallet() {
        if (!window.ethereum) return alert("Install Rabby/MetaMask!");
        const provider = new ethers.BrowserProvider(window.ethereum);
        const accounts = await provider.send("eth_requestAccounts", []);
        currentWallet = accounts[0];
        
        document.getElementById('auth-area').innerHTML = `User: ${currentWallet.substring(0,6)}...`;
        document.getElementById('edit-btn').style.display = 'inline-block';
        document.getElementById('post-area').style.display = 'block'; // Libera postagem

        loadProfile(currentWallet);
    }

    async function loadProfile(wallet) {
        try {
            const res = await fetch(`/api/get-profile/${wallet}`);
            const data = await res.json();
            if (data.name) {
                currentUserData = data;
                renderProfile(data);
            }
        } catch (e) { console.error(e); }
    }

    function renderProfile(data) {
        document.getElementById('display-name').innerText = data.name || "Guest";
        document.getElementById('display-status').innerText = data.status || "...";
        document.getElementById('display-img').src = data.avatar || "https://placehold.co/300";
        document.getElementById('display-interests').innerText = data.interests || "-";
        document.getElementById('display-bio').innerText = data.bio || "-";
    }

    // --- LÃ“GICA DE POSTAGEM ---
    async function submitPost() {
        const text = document.getElementById('post-text').value;
        const fileInput = document.getElementById('post-file');
        
        if (!text && fileInput.files.length === 0) return alert("Write something...");

        let imageUrl = "";
        
        // 1. Upload Imagem do Post (se houver)
        if (fileInput.files.length > 0) {
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            // Adiciona wallet para criar nome Ãºnico
            formData.append('wallet', currentWallet);

            const res = await fetch('/api/upload', { method: 'POST', body: formData });
            const data = await res.json();
            if (data.url) imageUrl = data.url;
        }

        // 2. Enviar Post
        const postPayload = {
            wallet: currentWallet,
            name: currentUserData.name || "Unknown Emo",
            avatar: currentUserData.avatar || "https://placehold.co/50",
            text: text,
            image: imageUrl
        };

        await fetch('/api/post', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(postPayload)
        });

        // Limpar e Recarregar
        document.getElementById('post-text').value = "";
        document.getElementById('post-file').value = "";
        loadFeed();
    }

    // --- LÃ“GICA DO FEED ---
    async function loadFeed() {
        try {
            const res = await fetch('/api/feed');
            const posts = await res.json();
            const container = document.getElementById('feed-container');
            container.innerHTML = "";

            if (posts.length === 0) {
                container.innerHTML = "<div style='padding:20px; text-align:center'>No posts yet. Be the first to cry.</div>";
                return;
            }

            posts.forEach(post => {
                const date = new Date(post.timestamp).toLocaleString();
                const html = `
                    <div class="feed-item">
                        <div class="feed-header">
                            <img src="${post.avatar}" class="feed-avatar">
                            <div>
                                <span class="feed-name">${post.name}</span>
                                <div class="feed-info">${date}</div>
                            </div>
                        </div>
                        <div class="feed-content">${post.text}</div>
                        ${post.image ? `<img src="${post.image}" class="feed-img">` : ''}
                    </div>
                `;
                container.innerHTML += html;
            });

        } catch (e) { console.error("Erro feed", e); }
    }

    // --- EDITOR ---
    window.openEditor = function() {
        document.getElementById('in-name').value = document.getElementById('display-name').innerText;
        document.getElementById('in-status').value = document.getElementById('display-status').innerText;
        document.getElementById('in-avatar-current').value = document.getElementById('display-img').src;
        document.getElementById('in-interests').value = document.getElementById('display-interests').innerText;
        document.getElementById('in-bio').value = document.getElementById('display-bio').innerText;
        document.getElementById('editor').style.display = 'block';
    }

    window.saveProfile = async function() {
        const fileInput = document.getElementById('in-avatar-file');
        let avatarUrl = document.getElementById('in-avatar-current').value;

        if (fileInput.files.length > 0) {
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('wallet', currentWallet); // Adiciona a wallet no form
            
            const res = await fetch('/api/upload', { method: 'POST', body: formData });
            const data = await res.json();
            if (data.url) avatarUrl = data.url;
        }

        const profileData = {
            name: document.getElementById('in-name').value,
            status: document.getElementById('in-status').value,
            avatar: avatarUrl,
            interests: document.getElementById('in-interests').value,
            bio: document.getElementById('in-bio').value
        };

        await fetch('/api/save-profile', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ wallet: currentWallet, data: profileData })
        });

        currentUserData = profileData; // Atualiza local
        renderProfile(profileData);
        document.getElementById('editor').style.display = 'none';
    }
</script>
</body>
</html>

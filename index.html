<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMODAK | Social Feed</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.11.1/ethers.umd.min.js"></script>
    <style>
        /* --- ESTILOS --- */
        body { background-color: #1a0b2e; background-image: url('https://upload.wikimedia.org/wikipedia/commons/5/59/Monad_Logo_Purple.png'); background-size: 60px; font-family: 'Verdana', sans-serif; font-size: 11px; margin: 0; color: #000; }
        #container { width: 900px; margin: 15px auto; background-color: #fff; min-height: 100vh; border: 3px solid #200052; display: flex; flex-direction: column; }
        
        .nav { background-color: #200052; height: 40px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; color: white; font-weight: bold; font-size: 14px; }
        .grid { display: flex; flex: 1; }
        
        /* Lateral Esquerda (Perfil) */
        .col-left { width: 280px; background: #E5E5E5; padding: 15px; text-align: center; border-right: 2px solid #000; }
        .pic-box { border: 2px solid #000; padding: 5px; background: white; margin-bottom: 10px; cursor: pointer;}
        .pic-box img { width: 100%; height: auto; aspect-ratio: 1/1; object-fit: cover; }
        
        .stats-box { display: flex; justify-content: space-around; font-size: 10px; margin: 10px 0; background: #ccc; padding: 5px; border: 1px solid #999; }
        
        /* Lateral Direita (Feed) */
        .col-right { flex: 1; padding: 20px; background: #fff; }

        .post-box { border: 2px solid #200052; background: #f0f0f0; padding: 10px; margin-bottom: 20px; }
        .post-box textarea { width: 96%; height: 60px; border: 1px solid #999; padding: 5px; resize: none; }
        
        /* Feed Item */
        .feed-item { border: 1px solid #ccc; padding: 10px; margin-bottom: 15px; background: #fff; box-shadow: 3px 3px 0px #ddd; }
        .feed-header { display: flex; align-items: center; margin-bottom: 8px; border-bottom: 1px dashed #ccc; padding-bottom: 5px; }
        .feed-avatar { width: 40px; height: 40px; border: 1px solid #000; margin-right: 10px; object-fit: cover; cursor: pointer; }
        .feed-name { font-weight: bold; font-size: 12px; color: #200052; cursor: pointer; }
        .feed-name:hover { text-decoration: underline; }
        .feed-content { font-size: 12px; line-height: 1.4; margin-bottom: 10px; white-space: pre-wrap; }
        .feed-img { max-width: 100%; border: 1px solid #000; margin-top: 5px; display: block; }

        /* Repost Style */
        .repost-box { border: 1px solid #200052; background: #f9f9f9; padding: 10px; margin-top: 5px; font-size: 11px; }

        /* Action Bar (Likes/Share) */
        .action-bar { margin-top: 10px; border-top: 1px solid #eee; padding-top: 5px; display: flex; gap: 15px; }
        .action-btn { background: none; border: none; cursor: pointer; font-size: 11px; font-weight: bold; color: #555; display: flex; align-items: center; gap: 5px; }
        .action-btn:hover { color: #200052; }
        .liked { color: #cc0000 !important; }

        button { cursor: pointer; border: 1px solid #000; background: #fff; font-weight: bold; padding: 5px 10px; }
        button:hover { background: #200052; color: white; }
        .btn-follow { width: 100%; background: #200052; color: white; margin-top: 5px; }
        .btn-following { width: 100%; background: #ccc; color: #000; margin-top: 5px; }

        #editor { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #f0f0f0; border: 3px solid #200052; padding: 20px; width: 400px; z-index: 999; box-shadow: 0 0 0 100vmax rgba(0,0,0,0.7); }
    </style>
</head>
<body>

<div id="container">
    <div class="nav">
        <div>ðŸ’œ EMODAK SOCIAL</div>
        <div id="auth-area"><button onclick="connectWallet()">[ Connect Wallet ]</button></div>
    </div>

    <div class="grid">
        <!-- PERFIL (ESQUERDA) -->
        <div class="col-left" id="profile-col">
            <!-- SerÃ¡ preenchido via JS -->
            <div style="padding:20px;">Connect wallet to see profile...</div>
        </div>

        <!-- FEED (DIREITA) -->
        <div class="col-right">
            
            <div class="post-box" id="post-area" style="display:none;">
                <b>What hurts today?</b>
                <textarea id="post-text" placeholder="Write something dark..."></textarea>
                <div style="display:flex; justify-content:space-between; margin-top:5px;">
                    <input type="file" id="post-file" accept="image/*" style="font-size:10px;">
                    <button style="background:#200052; color:white;" onclick="submitPost()">POST</button>
                </div>
            </div>

            <div style="margin-bottom: 10px; font-weight: bold; color: #200052; border-bottom: 1px solid #000;">
                Global Feed
            </div>

            <div id="feed-container">Loading...</div>
        </div>
    </div>
</div>

<!-- EDITOR -->
<div id="editor">
    <h3>Edit Profile</h3>
    <input type="text" id="in-name" placeholder="Name" style="width:95%; margin-bottom:5px;">
    <input type="text" id="in-status" placeholder="Status" style="width:95%; margin-bottom:5px;">
    <input type="file" id="in-avatar-file" style="margin-bottom:10px;">
    <input type="text" id="in-interests" placeholder="Interests" style="width:95%; margin-bottom:5px;">
    <textarea id="in-bio" placeholder="Bio" style="width:95%; height:50px;"></textarea>
    <input type="hidden" id="in-avatar-current">
    <button onclick="saveProfile()" style="width:100%; background:#200052; color:white;">SAVE</button>
    <button onclick="document.getElementById('editor').style.display='none'" style="width:100%; margin-top:5px;">CANCEL</button>
</div>

<script>
    let currentWallet = null;
    let viewingWallet = null; // Quem estamos vendo na esquerda
    let currentUserData = {};
    let viewingUserData = {};

    window.onload = () => loadFeed();

    async function connectWallet() {
        if (!window.ethereum) return alert("Install Wallet!");
        const provider = new ethers.BrowserProvider(window.ethereum);
        const accounts = await provider.send("eth_requestAccounts", []);
        currentWallet = accounts[0];
        
        document.getElementById('auth-area').innerHTML = `User: ${currentWallet.substring(0,6)}...`;
        document.getElementById('post-area').style.display = 'block';

        // Carrega meu perfil inicialmente
        loadProfileColumn(currentWallet);
    }

    // --- CARREGAR COLUNA DA ESQUERDA ---
    async function loadProfileColumn(wallet) {
        viewingWallet = wallet;
        try {
            const res = await fetch(`/api/get-profile/${wallet}`);
            const data = await res.json();
            viewingUserData = data;
            
            if(wallet === currentWallet) currentUserData = data; // Atualiza meus dados se for eu

            const isMe = currentWallet && wallet.toLowerCase() === currentWallet.toLowerCase();
            const followers = data.followers ? data.followers.length : 0;
            const following = data.following ? data.following.length : 0;
            const isFollowing = currentWallet && data.followers && data.followers.includes(currentWallet);

            let btnHtml = '';
            if (isMe) {
                btnHtml = `<button onclick="openEditor()" style="width:100%; margin-top:5px;">Edit Profile</button>`;
            } else if (currentWallet) {
                btnHtml = `<button class="${isFollowing ? 'btn-following' : 'btn-follow'}" onclick="followUser('${wallet}')">
                    ${isFollowing ? 'Following (Unfollow)' : 'Follow'}
                </button>`;
            }

            const html = `
                <h2 style="margin-top:0; word-break:break-all;">${data.name || 'Guest'}</h2>
                <div class="pic-box" onclick="alert('Viewing Profile: ${wallet}')">
                    <img src="${data.avatar || 'https://placehold.co/300'}" onerror="this.src='https://placehold.co/300'">
                </div>
                <div style="margin-bottom:10px;">"${data.status || '...'}"</div>
                
                <div class="stats-box">
                    <div><b>${followers}</b><br>Followers</div>
                    <div><b>${following}</b><br>Following</div>
                </div>

                ${btnHtml}
                <hr>
                <div style="text-align:left; font-size:10px;">
                    <b>Interests:</b> ${data.interests || '-'}<br><br>
                    <b>Bio:</b> ${data.bio || '-'}
                </div>
                ${!isMe ? `<div style="margin-top:10px; font-size:9px; color:#555;">ID: ${wallet.substring(0,10)}...</div>` : ''}
            `;
            document.getElementById('profile-col').innerHTML = html;

        } catch (e) { console.error(e); }
    }

    // --- FEED SYSTEM ---
    async function loadFeed() {
        try {
            const res = await fetch('/api/feed');
            const posts = await res.json();
            const container = document.getElementById('feed-container');
            container.innerHTML = "";

            if (posts.length === 0) return container.innerHTML = "<div style='padding:20px;'>No posts yet.</div>";

            posts.forEach(post => {
                const isLiked = currentWallet && post.likes && post.likes.includes(currentWallet);
                const likeCount = post.likes ? post.likes.length : 0;
                
                // HTML do ConteÃºdo (Suporta Repost)
                let contentHtml = `<div class="feed-content">${post.text || ''}</div>`;
                if (post.image) contentHtml += `<img src="${post.image}" class="feed-img">`;

                if (post.originalPost) {
                    contentHtml += `
                        <div class="repost-box">
                            <b>Repost from ${post.originalPost.name}:</b><br>
                            ${post.originalPost.text}
                            ${post.originalPost.image ? '<br>[Image]' : ''}
                        </div>
                    `;
                }

                const html = `
                    <div class="feed-item">
                        <div class="feed-header">
                            <img src="${post.avatar}" class="feed-avatar" onclick="loadProfileColumn('${post.wallet}')">
                            <div>
                                <span class="feed-name" onclick="loadProfileColumn('${post.wallet}')">${post.name}</span>
                                <div class="feed-info">${new Date(post.timestamp).toLocaleString()}</div>
                            </div>
                        </div>
                        
                        ${contentHtml}

                        <div class="action-bar">
                            <button class="action-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${post.filename}')">
                                ${isLiked ? 'ðŸ–¤' : 'â™¡'} ${likeCount} Likes
                            </button>
                            <button class="action-btn" onclick="sharePost('${post.id}', '${escape(post.text)}', '${escape(post.name)}')">
                                ðŸ”„ Share
                            </button>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });

        } catch (e) { console.error(e); }
    }

    // --- ACTIONS ---
    async function submitPost(originalPostData = null) {
        const text = document.getElementById('post-text').value;
        const fileInput = document.getElementById('post-file');
        
        if (!text && !fileInput.files.length && !originalPostData) return alert("Empty post...");

        let imageUrl = "";
        if (fileInput.files.length > 0) {
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            const res = await fetch('/api/upload', { method: 'POST', body: formData });
            const d = await res.json();
            if (d.url) imageUrl = d.url;
        }

        const payload = {
            wallet: currentWallet,
            name: currentUserData.name || "Unknown",
            avatar: currentUserData.avatar || "https://placehold.co/50",
            text: text,
            image: imageUrl,
            originalPost: originalPostData // Se for repost, manda os dados
        };

        await fetch('/api/post', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        document.getElementById('post-text').value = "";
        document.getElementById('post-file').value = "";
        loadFeed();
    }

    async function toggleLike(filename) {
        if (!currentWallet) return alert("Connect wallet to like!");
        await fetch('/api/like', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ wallet: currentWallet, filename })
        });
        loadFeed(); // Recarrega para mostrar novo like
    }

    function sharePost(id, text, name) {
        const confirmShare = confirm(`Repost this from ${unescape(name)}?`);
        if (confirmShare) {
            submitPost({ id, text: unescape(text), name: unescape(name) });
        }
    }

    async function followUser(targetWallet) {
        if (!currentWallet) return alert("Connect wallet!");
        const res = await fetch('/api/follow', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ follower: currentWallet, target: targetWallet })
        });
        const data = await res.json();
        if (data.success) loadProfileColumn(targetWallet); // Atualiza botÃ£o
    }

    // --- PROFILE EDIT ---
    window.openEditor = function() {
        document.getElementById('in-name').value = currentUserData.name || "";
        document.getElementById('in-status').value = currentUserData.status || "";
        document.getElementById('in-avatar-current').value = currentUserData.avatar || "";
        document.getElementById('in-interests').value = currentUserData.interests || "";
        document.getElementById('in-bio').value = currentUserData.bio || "";
        document.getElementById('editor').style.display = 'block';
    }

    window.saveProfile = async function() {
        const fileInput = document.getElementById('in-avatar-file');
        let avatarUrl = document.getElementById('in-avatar-current').value;

        if (fileInput.files.length > 0) {
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            const res = await fetch('/api/upload', { method: 'POST', body: formData });
            const d = await res.json();
            if (d.url) avatarUrl = d.url;
        }

        const data = {
            name: document.getElementById('in-name').value,
            status: document.getElementById('in-status').value,
            avatar: avatarUrl,
            interests: document.getElementById('in-interests').value,
            bio: document.getElementById('in-bio').value
        };

        await fetch('/api/save-profile', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ wallet: currentWallet, data })
        });
        
        currentUserData = { ...currentUserData, ...data };
        loadProfileColumn(currentWallet);
        document.getElementById('editor').style.display = 'none';
    }
</script>
</body>
</html>

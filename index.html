<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMODAK | Volume Storage</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.11.1/ethers.umd.min.js"></script>
    <style>
        body { background-color: #1a0b2e; background-image: url('https://upload.wikimedia.org/wikipedia/commons/5/59/Monad_Logo_Purple.png'); background-size: 60px; font-family: 'Verdana', sans-serif; font-size: 11px; margin: 0; color: #000; }
        #container { width: 800px; margin: 15px auto; background-color: #fff; min-height: 100vh; border: 3px solid #200052; }
        .nav { background-color: #200052; height: 35px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; color: white; font-weight: bold; }
        .grid { display: flex; width: 100%; }
        .col-left { width: 300px; background: #E5E5E5; padding: 15px; text-align: center; border-right: 1px solid #999; }
        .col-right { flex: 1; padding: 15px; background: #fff; }
        .pic-box { border: 2px solid #000; padding: 5px; background: white; margin-bottom: 10px; }
        .pic-box img { width: 100%; height: auto; aspect-ratio: 1/1; object-fit: cover; }
        .orange-header { background-color: #200052; color: white; font-weight: bold; padding: 3px 10px; margin-top: 15px; }
        button { cursor: pointer; border: 1px solid #000; background: #fff; font-weight: bold; padding: 5px; }
        
        #editor { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #f0f0f0; border: 3px solid #200052; padding: 20px; width: 400px; z-index: 999; box-shadow: 0 0 0 100vmax rgba(0,0,0,0.7); }
        input[type="text"], textarea { width: 95%; padding: 5px; margin-bottom: 10px; }
        input[type="file"] { margin-bottom: 10px; width: 100%; }
    </style>
</head>
<body>

<div id="container">
    <div class="nav">
        <div>ðŸ’œ EMODAK.VOL</div>
        <div id="auth-area"><button onclick="connectWallet()">[ Connect Wallet ]</button></div>
    </div>

    <div class="grid">
        <div class="col-left">
            <h2 id="display-name" style="margin-top:0;">Anonymous</h2>
            <div class="pic-box"><img id="display-img" src="https://placehold.co/300?text=?"></div>
            <div style="margin-bottom:15px;">"<span id="display-status">...</span>"<br><span style="font-size:9px;">Last Login: NOW</span></div>
            <div style="font-size:10px;"><b>ID:</b> <span id="wallet-id">...</span></div>
        </div>
        <div class="col-right">
            <div style="border:1px solid #000; padding:10px; font-weight:bold; margin-bottom:10px;"><span class="d-name">User</span> is in your extended network.</div>
            <div style="text-align:right;"><button id="edit-btn" style="display:none;" onclick="openEditor()">[ Edit Profile ]</button></div>
            <div class="orange-header">Interests</div><p id="display-interests">Loading...</p>
            <div class="orange-header">About Me</div><p id="display-bio">Loading...</p>
        </div>
    </div>
</div>

<div id="editor">
    <h3>Edit Profile (Server Storage)</h3>
    <label>Name:</label><input type="text" id="in-name">
    <label>Status:</label><input type="text" id="in-status">
    <label>Upload New Avatar:</label><br><input type="file" id="in-avatar-file" accept="image/*"><br>
    <input type="hidden" id="in-avatar-current">
    <label>Interests:</label><input type="text" id="in-interests">
    <label>Bio:</label><textarea id="in-bio" rows="3"></textarea>
    <button id="btn-save" style="background:#200052; color:white; width:100%" onclick="saveProfile()">SAVE TO VOLUME</button>
    <button style="width:100%; margin-top:5px;" onclick="document.getElementById('editor').style.display='none'">CANCEL</button>
</div>

<script>
    let currentWallet = null;

    async function connectWallet() {
        if (!window.ethereum) return alert("Instale Rabby/MetaMask!");
        const provider = new ethers.BrowserProvider(window.ethereum);
        const accounts = await provider.send("eth_requestAccounts", []);
        currentWallet = accounts[0];
        updateUI(currentWallet);
        loadProfile(currentWallet);
    }

    async function loadProfile(wallet) {
        try {
            const res = await fetch(`/api/get-profile/${wallet}`);
            const data = await res.json();
            if (data) renderProfile(data);
            else renderProfile({ name: "New Emo", status: "Fresh", avatar: "https://placehold.co/300", interests: "-", bio: "-" });
        } catch (e) { console.error(e); }
    }

    async function saveProfile() {
        if (!currentWallet) return;
        const btn = document.getElementById('btn-save');
        btn.innerText = "SAVING..."; btn.disabled = true;

        try {
            let avatarUrl = document.getElementById('in-avatar-current').value;
            const fileInput = document.getElementById('in-avatar-file');

            // 1. Upload da imagem (se tiver)
            if (fileInput.files.length > 0) {
                const formData = new FormData();
                formData.append('avatar', fileInput.files[0]);
                formData.append('wallet', currentWallet);

                const uploadRes = await fetch('/api/upload-avatar', { method: 'POST', body: formData });
                const uploadData = await uploadRes.json();
                if (uploadData.url) avatarUrl = uploadData.url;
            }

            // 2. Salvar dados do perfil
            const profileData = {
                name: document.getElementById('in-name').value,
                status: document.getElementById('in-status').value,
                avatar: avatarUrl,
                interests: document.getElementById('in-interests').value,
                bio: document.getElementById('in-bio').value
            };

            await fetch('/api/save-profile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ wallet: currentWallet, data: profileData })
            });

            renderProfile(profileData);
            document.getElementById('editor').style.display = 'none';
            alert("âœ… Saved to Railway Volume!");

        } catch (e) { alert("Error saving: " + e.message); } 
        finally { btn.innerText = "SAVE TO VOLUME"; btn.disabled = false; }
    }

    function updateUI(wallet) {
        document.getElementById('auth-area').innerHTML = `User: ${wallet.substring(0,6)}...`;
        document.getElementById('wallet-id').innerText = wallet;
        document.getElementById('edit-btn').style.display = 'inline-block';
    }

    function renderProfile(data) {
        document.getElementById('display-name').innerText = data.name;
        document.querySelector('.d-name').innerText = data.name;
        document.getElementById('display-status').innerText = data.status;
        document.getElementById('display-img').src = data.avatar;
        document.getElementById('display-interests').innerText = data.interests;
        document.getElementById('display-bio').innerText = data.bio;
    }

    window.openEditor = function() {
        document.getElementById('in-name').value = document.getElementById('display-name').innerText;
        document.getElementById('in-status').value = document.getElementById('display-status').innerText;
        document.getElementById('in-avatar-current').value = document.getElementById('display-img').src;
        document.getElementById('in-interests').value = document.getElementById('display-interests').innerText;
        document.getElementById('in-bio').value = document.getElementById('display-bio').innerText;
        document.getElementById('editor').style.display = 'block';
    }
</script>
</body>
</html>
